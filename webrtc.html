<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Live Stream</title>
</head>
<body>
    <h1>WebRTC Live Stream</h1>
    <video id="localVideo" autoplay muted playsinline></video>
    <div id="remoteVideos"></div>

    <script src="https://cdn.jsdelivr.net/npm/simple-peer"></script>
    <script src="https://cdn.socket.io/4.1.3/socket.io.min.js"></script>

    <script>
        const userId = Math.random().toString(36).substring(7);
        const socket = io('wss://vdevapi.online');

        const localVideo = document.getElementById('localVideo');
        const remoteVideosContainer = document.getElementById('remoteVideos');
        const peers = {};

        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
            .then((stream) => {
                localVideo.srcObject = stream;

                socket.emit('new-user', userId);

                socket.on('new-user', (newUserId) => {
                    console.log(`Novo usuário conectado - ID: ${newUserId}`);
                    createPeerConnection(newUserId, stream);
                });

                socket.on('existing-users', (existingUsers) => {
                    existingUsers.forEach((existingUserId) => {
                        console.log(`Usuário existente conectado - ID: ${existingUserId}`);
                        createPeerConnection(existingUserId, stream);
                    });
                });

                socket.on('user-disconnected', (disconnectedUserId) => {
                    console.log(`Usuário desconectado - ID: ${disconnectedUserId}`);
                    const peer = peers[disconnectedUserId];
                    if (peer) {
                        peer.destroy();
                        delete peers[disconnectedUserId];
                        removeVideoElement(disconnectedUserId);
                    }
                });
            })
            .catch((error) => console.error('Erro ao acessar a webcam:', error));

        function createPeerConnection(remoteUserId, stream) {
            const peer = new SimplePeer({ initiator: true, trickle: false, stream });

            peer.on('signal', (data) => {
                socket.emit('offer', { offer: data, userId, remoteUserId });
            });

            peer.on('connect', () => {
                console.log('Conexão estabelecida com sucesso');
            });

            peer.on('stream', (remoteStream) => {
                console.log(`Recebendo stream de ${remoteUserId}`);
                const remoteVideo = createVideoElement(remoteUserId);
                remoteVideo.srcObject = remoteStream;
            });

            socket.on('offer', (data) => {
                if (data.userId === remoteUserId) {
                    peer.signal(data.offer);
                }
            });

            socket.on('answer', (data) => {
                if (data.userId === remoteUserId) {
                    peer.signal(data.answer);
                }
            });

            socket.on('ice-candidate', (data) => {
                if (data.userId === remoteUserId) {
                    peer.signal(data.iceCandidate);
                }
            });

            peers[remoteUserId] = peer;
        }

        function createVideoElement(remoteUserId) {
            const remoteVideo = document.createElement('video');
            remoteVideo.autoplay = true;
            remoteVideo.playsinline = true;
            remoteVideo.id = `video-${remoteUserId}`;
            remoteVideosContainer.appendChild(remoteVideo);
            return remoteVideo;
        }

        function removeVideoElement(remoteUserId) {
            const remoteVideo = document.getElementById(`video-${remoteUserId}`);
            if (remoteVideo) {
                remoteVideo.remove();
            }
        }
    </script>
</body>
</html>
